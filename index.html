<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI è‡ªå‹•åˆ†é æŠ“å– (ä¿®æ­£ç‰ˆ)</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 40px;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #showListBtn {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: 0.3s;
        }

        #showListBtn:hover {
            background-color: #218838;
        }

        /* æ¸…å–®å®¹å™¨ */
        #midiListContainer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 600px;
            height: 75vh;
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            z-index: 1000;
            border: 1px solid #ddd;
            flex-direction: column;
            overflow: hidden;
        }

        .list-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-header h3 {
            margin: 0;
            color: #333;
        }

        #closeList {
            cursor: pointer;
            font-size: 28px;
            color: #aaa;
            line-height: 1;
        }

        #closeList:hover {
            color: #ff4d4d;
        }

        #midiList {
            overflow-y: auto;
            flex: 1;
            padding: 10px;
        }

        .midi-item {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            color: #444;
            transition: background 0.2s;
        }

        .midi-item:hover {
            background-color: #e9ecef;
            color: #000;
        }

        .status-box {
            padding: 20px;
            text-align: center;
            color: #555;
            background: #fffde7;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .success-box {
            padding: 10px;
            background: #d4edda;
            color: #155724;
            text-align: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <button id="showListBtn">ğŸ“‚ é–‹å•Ÿ MIDI åˆ—è¡¨ (æŠ“å–æ‰€æœ‰åˆ†é )</button>

    <div id="midiListContainer">
        <div class="list-header">
            <h3>ğŸµ MIDI æª”æ¡ˆåº«</h3>
            <span id="closeList">&times;</span>
        </div>
        <div id="midiList">
            <p style="text-align:center; padding:20px;">æº–å‚™ä¸­...</p>
        </div>
    </div>

    <script type="module">
        // åˆå§‹è¨­å®šï¼šåŒ…å«æ’åºèˆ‡æ¯é æ•¸é‡

        const showListBtn = document.getElementById("showListBtn");
        const midiListContainer = document.getElementById("midiListContainer");
        const midiListDiv = document.getElementById("midiList");
        const closeList = document.getElementById("closeList");

        export let midiList = [];
        let isFullyLoaded = false;

        // è¼”åŠ©ï¼šæ’åºå‡½æ•¸
        function sortByTitle(data) {
            return [...data].sort((a, b) => {
                const titleA = a.title ? a.title.toUpperCase() : '';
                const titleB = b.title ? b.title.toUpperCase() : '';
                return titleA < titleB ? -1 : (titleA > titleB ? 1 : 0);
            });
        }

        // æ ¸å¿ƒï¼šè¼‰å…¥æ‰€æœ‰åˆ†é è³‡æ–™
        export async function loadMidiFiles() {
            if (isFullyLoaded) return;

            console.log("ğŸš€ é–‹å§‹æŠ“å–...");
            midiListContainer.style.display = "flex";
            midiListDiv.innerHTML = `<div class="status-box">æ­£åœ¨åˆå§‹åŒ–è«‹æ±‚...</div>`;

            midiList = [];

            let page = 1;
            let url = `https://imuse.ncnu.edu.tw/Midi-library/api/midis?page=${page}&limit=100&sort=uploaded_at&order=desc`;

            try {
                while (url) {

                    // UI: loading ç‹€æ…‹
                    midiListDiv.innerHTML = `
                <div class="status-box">
                    <p>â³ æ­£åœ¨è®€å–ç¬¬ <b>${page}</b> é ...</p>
                    <small>ä¾†æº: ${url}</small><br>
                    <p>ç›®å‰å·²ç´¯ç©: ${midiList.length} ç­†</p>
                </div>`;

                    // 1. fetch API
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);

                    const json = await res.json();

                    // 2. æ²’æœ‰ items â†’ åœæ­¢
                    const items = Array.isArray(json.items) ? json.items : [];
                    if (items.length === 0) {
                        console.log(`ğŸ“­ ç¬¬ ${page} é ç‚ºç©º â†’ åœæ­¢æŠ“å–`);
                        break;
                    }

                    // 3. åŠ å…¥ç´¯ç©æ¸…å–®
                    midiList = [...midiList, ...items];
                    console.log(`ç¬¬ ${page} é æŠ“å–æˆåŠŸ: ${items.length} ç­†`);

                    // 4. ç”Ÿæˆä¸‹ä¸€é  URLï¼ˆä½¿ç”¨ if(url)ï¼‰
                    page++;
                    const next = `https://imuse.ncnu.edu.tw/Midi-library/api/midis?page=${page}&limit=100&sort=uploaded_at&order=desc`;

                    // åˆ¤æ–· URL æ˜¯å¦å­˜åœ¨ï¼ˆæ ¼å¼åˆ¤æ–·ï¼‰
                    if (next) {
                        url = next;
                    } else {
                        url = null;
                    }

                    // (å¯é¸) é¿å… rate limit
                    await new Promise(r => setTimeout(r, 250));
                }

                // 5. æ’åº
                midiList = sortByTitle(midiList);
                isFullyLoaded = true;

                // 6. æ¸²æŸ“åˆ—è¡¨
                renderMidiList();

            } catch (err) {
                console.error("è¼‰å…¥éŒ¯èª¤:", err);
                midiListDiv.innerHTML += `
            <p style='color:red; text-align:center;'>âŒ ç™¼ç”ŸéŒ¯èª¤ (ç¬¬ ${page} é ): ${err.message}</p>`;
            }
        }


        // æ¸²æŸ“åˆ—è¡¨
        function renderMidiList() {
            midiListDiv.innerHTML = ""; // æ¸…ç©º

            // é ‚éƒ¨è³‡è¨Šåˆ—
            const infoDiv = document.createElement("div");
            infoDiv.className = "success-box";
            infoDiv.innerHTML = `âœ… è¼‰å…¥å®Œæˆï¼å…± <b>${midiList.length}</b> ç­†è³‡æ–™ (å·²ä¾æ¨™é¡Œæ’åº)`;
            midiListDiv.appendChild(infoDiv);

            midiList.forEach(mid => {
                const div = document.createElement("div");
                div.className = "midi-item";
                div.textContent = mid.title;
                div.addEventListener("click", () => handleDownload(mid, div));
                midiListDiv.appendChild(div);
            });
        }

        // è™•ç†ä¸‹è¼‰é»æ“Š
        async function handleDownload(mid, divElement) {
            const originalText = divElement.textContent;
            divElement.style.background = "#fff3cd";
            divElement.textContent = `â³ ä¸‹è¼‰ä¸­... ${mid.title}`;

            try {
                const downloadUrl = `https://imuse.ncnu.edu.tw/Midi-library/api/midis/${mid.id}/download`;
                const res = await fetch(downloadUrl);
                if (!res.ok) throw new Error(res.status);

                const arrayBuffer = await res.arrayBuffer();
                console.log("ä¸‹è¼‰æˆåŠŸ (ArrayBuffer):", arrayBuffer);

                divElement.style.background = "#d4edda";
                divElement.textContent = `âœ… å®Œæˆ: ${mid.title}`;

                // 1.5ç§’å¾Œå¾©åŸ
                setTimeout(() => {
                    divElement.style.background = "";
                    divElement.textContent = originalText;
                }, 1500);

            } catch (err) {
                console.error(err);
                divElement.style.color = "red";
                divElement.textContent = `âŒ ä¸‹è¼‰å¤±æ•—`;
            }
        }

        // äº‹ä»¶ç¶å®š
        closeList.addEventListener("click", () => {
            midiListContainer.style.display = "none";
        });

        showListBtn.addEventListener("click", () => {
            if (!isFullyLoaded) {
                loadMidiFiles();
            } else {
                midiListContainer.style.display = "flex";
            }
        });
    </script>
</body>

</html>